<div class="max-w-3xl mx-auto p-4 sm:p-6 bg-white rounded-lg shadow-md border border-slate-200 text-slate-800">

  <!-- Start Screen -->
  @if (gameState() === 'notStarted') {
    <div class="text-center">
      <h1 class="text-4xl font-bold font-cinzel text-teal-700">Desafío Rápido</h1>
      @if (lastScore() !== null) {
        <p class="mt-4 text-lg">Tu último puntaje fue: <span class="font-bold text-teal-600">{{ lastScore() }}</span>.</p>
        <p class="mt-2 text-slate-600">¿Crees que puedes superarlo?</p>
      } @else {
        <p class="mt-4 text-lg">Responde tantas preguntas como puedas en 60 segundos.</p>
        <p class="mt-2 text-slate-600">Cada acierto te da puntos, y las rachas de aciertos aumentan tu multiplicador. ¡Pero cuidado! Un error te restará 5 segundos. Tres errores seguidos y el juego termina.</p>
      }

      <div class="mt-8 flex flex-col items-center gap-4">
        <button (click)="startGame('normal')"
                class="px-8 py-4 w-full max-w-sm bg-teal-600 text-white font-bold text-xl rounded-lg shadow-md hover:bg-teal-700 transition-all duration-200 active:scale-95">
          @if (lastScore() !== null) {
            <span>Jugar Desafío Normal</span>
          } @else {
            <span>¡Comenzar!</span>
          }
        </button>

        @if(activeEvent(); as event) {
           <button (click)="startGame('event')"
                  [disabled]="isEventRewardClaimed()"
                  class="px-8 py-4 w-full max-w-sm bg-amber-500 text-white font-bold text-xl rounded-lg shadow-md hover:bg-amber-600 transition-all duration-200 active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed">
             @if(isEventRewardClaimed()) {
               <span>Evento Completado</span>
             } @else {
               <span>Participar en Evento</span>
             }
           </button>
        }
      </div>

    </div>
  }

  <!-- Game In Progress -->
  @if (gameState() === 'inProgress' && currentQuestion(); as question) {
    <div class="relative">
      <!-- Pause Overlay -->
      @if(isPaused()) {
        <div class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-lg">
          <h2 class="text-4xl font-bold font-cinzel text-slate-700">Juego Pausado</h2>
          <button (click)="resumeGame()" class="mt-8 px-8 py-4 bg-teal-600 text-white font-bold text-xl rounded-lg shadow-md hover:bg-teal-700 transition-all duration-200 active:scale-95 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
            </svg>
            <span>Reanudar</span>
          </button>
        </div>
      }

      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div class="text-2xl font-bold bg-teal-600 text-white rounded-full flex items-center justify-center w-16 h-16 shadow-md">
          {{ timer() }}
        </div>
        <div>
          <span class="text-xl font-bold">Puntaje: {{ score() }}</span>
          <span class="ml-4 text-lg text-teal-600 font-bold">x{{ scoreMultiplier() }}</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex space-x-1">
            <div class="w-5 h-5 rounded-full border border-slate-400" [class.bg-red-500]="errors() >= 1" [class.bg-transparent]="errors() < 1"></div>
            <div class="w-5 h-5 rounded-full border border-slate-400" [class.bg-red-500]="errors() >= 2" [class.bg-transparent]="errors() < 2"></div>
            <div class="w-5 h-5 rounded-full border border-slate-400" [class.bg-red-500]="errors() >= 3" [class.bg-transparent]="errors() < 3"></div>
          </div>
           @if (!isPaused()) {
            <button (click)="pauseGame()" title="Pausar juego" aria-label="Pausar juego" class="p-2 rounded-full bg-slate-100 hover:bg-slate-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6" />
                </svg>
            </button>
          }
        </div>
      </div>
      
      <!-- Question -->
      <div class="p-6 bg-slate-50 rounded-lg border border-slate-200">
        @if (challengeMode() === 'event' && activeEvent(); as event) {
          <p class="text-sm text-amber-600 font-bold tracking-wider uppercase">EVENTO: {{ event.title }}</p>
        } @else {
          <p class="text-sm text-slate-500 font-bold tracking-wider uppercase">{{ question.category }}</p>
        }
        <p class="text-2xl font-semibold my-4 text-center">{{ question.text }}</p>
      </div>

      <!-- Verse Hint (Profecía Power-up) -->
      @if(showVerse()) {
        <div class="mt-4 p-3 bg-teal-50 border-l-4 border-teal-500 text-teal-800 rounded-r-lg italic shadow-sm">
          <p>{{ question.verse }}</p>
        </div>
      }

      <!-- Options -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
        @for (option of filteredOptions(); track $index) {
          <button (click)="selectAnswer(option)" [disabled]="selectedAnswer() !== null"
                  class="p-4 text-lg font-medium text-left rounded-lg shadow-sm border transition-all duration-200 active:scale-[0.98]"
                  [class.bg-white]="selectedAnswer() === null"
                  [class.border-slate-300]="selectedAnswer() === null"
                  [class.hover:bg-teal-50]="selectedAnswer() === null"
                  [class.hover:border-teal-400]="selectedAnswer() === null"
                  [class.bg-green-500]="answerStatus() === 'correct' && selectedAnswer() === option"
                  [class.border-green-600]="answerStatus() === 'correct' && selectedAnswer() === option"
                  [class.scale-105]="answerStatus() === 'correct' && selectedAnswer() === option"
                  [class.bg-red-500]="answerStatus() === 'incorrect' && selectedAnswer() === option"
                  [class.border-red-600]="answerStatus() === 'incorrect' && selectedAnswer() === option"
                  [class.text-white]="(answerStatus() === 'correct' || answerStatus() === 'incorrect') && selectedAnswer() === option"
                  [class.opacity-60]="selectedAnswer() !== null && selectedAnswer() !== option"
                  [class.cursor-not-allowed]="selectedAnswer() !== null && selectedAnswer() !== option"
                  [class.bg-slate-100]="selectedAnswer() !== null && selectedAnswer() !== option"
                  [class.border-slate-200]="selectedAnswer() !== null && selectedAnswer() !== option"
                  [class.border-2]="selectedAnswer() === option && answerStatus() === null"
                  [class.border-teal-500]="selectedAnswer() === option && answerStatus() === null">
            {{ option }}
          </button>
        }
      </div>

      <!-- Power-ups & Thinking Mode -->
      <div class="mt-8 pt-4 border-t border-dashed border-slate-300 flex flex-wrap justify-center items-center gap-2 sm:gap-4">
        <button (click)="usePowerUp('remove_options')" [disabled]="removeOptionsCount() === 0 || optionsToRemove().length > 0" class="powerup-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a1 1 0 01-1 1H6a1 1 0 01-1-1v-1H4a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /><path d="M2 11h16v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5z" /></svg>
            Claridad ({{ removeOptionsCount() }})
        </button>
        <button (click)="usePowerUp('add_time')" [disabled]="addTimeCount() === 0" class="powerup-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
            Aliento ({{ addTimeCount() }})
        </button>
        <button (click)="usePowerUp('show_verse')" [disabled]="showVerseCount() === 0 || showVerse()" class="powerup-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
            Profecía ({{ showVerseCount() }})
        </button>
        <button (click)="openThinkingMode()" class="powerup-btn bg-indigo-500 text-white hover:bg-indigo-600 border-indigo-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM4 17a1 1 0 001.447.894l4-2A1 1 0 0010 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 004 7v10z" /></svg>
            Pensamiento
        </button>
      </div>

    </div>
  }

  <!-- Finished Screen -->
  @if (gameState() === 'finished') {
    <div class="text-center">
      <h1 class="text-4xl font-bold font-cinzel text-teal-700">¡Desafío Terminado!</h1>
      <p class="mt-4 text-2xl">Tu puntaje final es:</p>
      <p class="my-4 text-7xl font-bold text-teal-600">{{ score() }}</p>
       @if (challengeMode() === 'normal') {
          <p class="text-lg">Has ganado <span class="font-bold">{{ score() }}</span> de Fe.</p>
       } @else {
         <p class="text-lg">¡Tus respuestas correctas han sido añadidas al progreso del evento!</p>
       }
      <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
        <button (click)="startGame(challengeMode())"
                class="px-6 py-3 bg-teal-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-teal-700 transition-all duration-200 active:scale-95">
          Jugar de Nuevo
        </button>
        <button (click)="goHome()"
                class="px-6 py-3 bg-slate-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-slate-700 transition-all duration-200 active:scale-95">
           @if (challengeMode() === 'event') {
            <span>Volver al Evento</span>
           } @else {
            <span>Menú Principal</span>
           }
        </button>
      </div>
    </div>
  }
</div>

<!-- Thinking Mode Modal -->
@if(isThinkingModalOpen()){
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeThinkingMode()">
    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 relative" (click)="$event.stopPropagation()">
      <button (click)="closeThinkingMode()" aria-label="Cerrar modal de pensamiento profundo" class="absolute top-3 right-3 text-3xl text-slate-500 hover:text-slate-800 leading-none">&times;</button>
      <h2 class="text-2xl font-bold font-cinzel text-teal-700 mb-4">Profundizando el Conocimiento</h2>
      @if(isThinking()){
        <div class="flex flex-col items-center justify-center min-h-[200px]">
           <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-teal-600"></div>
           <p class="mt-4 text-lg text-slate-600">Pensando...</p>
        </div>
      } @else {
        <div class="prose max-w-none text-slate-800">
           {{ thinkingModeContent() }}
        </div>
      }
    </div>
  </div>
}

<style>
.powerup-btn {
  @apply px-3 py-2 sm:px-4 text-sm sm:text-base bg-white border border-slate-400 text-slate-600 font-semibold rounded-lg shadow-sm hover:bg-slate-100 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center active:scale-95;
}
</style>
