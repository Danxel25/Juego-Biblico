<header class="bg-white/95 text-slate-800 shadow-md sticky top-0 z-50 backdrop-blur-sm border-b border-slate-200 dark:bg-gray-900/95 dark:text-slate-200 dark:border-slate-700">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex-shrink-0">
        <a routerLink="/main-menu" class="text-2xl font-bold font-cinzel text-teal-700 dark:text-teal-400">Cruzada Celestial</a>
      </div>
      
      <div class="flex items-center gap-x-2 sm:gap-x-4">
        <!-- Theme Toggle -->
        <button (click)="toggleTheme()" 
                aria-label="Cambiar modo de color" 
                class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
          @if(theme() === 'dark') {
            <!-- Sun Icon for Light Mode -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          } @else {
            <!-- Moon Icon for Dark Mode -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          }
        </button>
        
        <!-- Profile Dropdown -->
        @if(user(); as currentUser) {
          <div class="relative">
            <button (click)="toggleProfileMenu()" class="flex items-center justify-center p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 group">
              <img class="h-9 w-9 rounded-full border-2 border-teal-500 object-cover transition-all group-hover:ring-4 group-hover:ring-teal-200" [src]="currentUser.avatarUrl" [alt]="currentUser.customName">
            </button>

            @if(isProfileMenuOpen()) {
              <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-slate-200/80 focus:outline-none origin-top-right overflow-hidden dark:bg-gray-800 dark:border-slate-700"
                   [class.animate-fade-in-down]="!isClosing()"
                   [class.animate-fade-out-up]="isClosing()">
                
                <!-- Dropdown Header -->
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center gap-4 dark:bg-slate-900 dark:border-slate-700">
                  <img class="h-12 w-12 rounded-full border-2 border-teal-500 object-cover" [src]="currentUser.avatarUrl" [alt]="currentUser.customName">
                  <div>
                    <p class="text-base font-bold text-slate-800 dark:text-slate-100" role="none">{{ currentUser.customName }}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400" role="none">{{ currentUser.title }}</p>
                  </div>
                </div>

                <!-- Menu Links -->
                <div class="divide-y divide-slate-200/60 dark:divide-slate-700">
                  <div class="p-2">
                    <a routerLink="/profile" (click)="closeProfileMenu()" class="profile-menu-link">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                      <span>Mi Perfil</span>
                    </a>
                  </div>
                  <div class="p-2">
                    <a routerLink="/store" (click)="closeProfileMenu()" class="profile-menu-link">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                      <span>Tienda</span>
                    </a>
                  </div>
                  <div class="p-2">
                    <a routerLink="/settings" (click)="closeProfileMenu()" class="profile-menu-link">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                      <span>Ajustes</span>
                    </a>
                  </div>
                   <div class="p-2 sm:hidden">
                     <a routerLink="/main-menu" (click)="closeProfileMenu()" class="profile-menu-link">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg>
                      <span>Menú Principal</span>
                    </a>
                   </div>
                  <div class="p-2">
                    <button (click)="logout()" class="profile-menu-link text-red-600 hover:bg-red-50 hover:text-red-700 w-full dark:text-red-400 dark:hover:bg-red-900/40 dark:hover:text-red-300">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3.03-5.53l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                      <span>Cerrar Sesión</span>
                    </button>
                  </div>
                </div>

              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</header>

<style>
  .nav-link {
    @apply flex items-center gap-x-1.5 px-3 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100 cursor-pointer transition-colors duration-200 dark:text-slate-300 dark:hover:bg-slate-800;
  }
  .active-nav-link {
      @apply bg-teal-100 text-teal-800 font-semibold dark:bg-teal-900/50 dark:text-teal-300;
  }
  .profile-menu-link {
      @apply flex items-center justify-center gap-3 px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded-md cursor-pointer transition-all duration-200 w-full dark:text-slate-200 dark:hover:bg-slate-700;
  }
  
  @keyframes fade-in-down {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .animate-fade-in-down {
    animation: fade-in-down 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  
  @keyframes fade-out-up {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
  }

  .animate-fade-out-up {
    animation: fade-out-up 0.2s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
  }
</style>